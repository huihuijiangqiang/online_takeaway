<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>我的购物车</title>

    <!-- 引入facicon.ico网页图标 -->
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <!-- 引入css 初始化的css 文件 -->
    <link rel="stylesheet" href="./statci/css/buycarbase.css">
    <!-- 引入公共样式的css 文件 -->
    <link rel="stylesheet" href="./statci/css/buycarcommon.css">
    <!-- 引入car css -->
    <link rel="stylesheet" href="./statci/css/car.css">
    <!-- 先引入jquery  -->
    <script src="./statci/js/json3.js"></script>
    <script src="./statci/js/jquery.min.js"></script>

    <!--    Handlebars填充数据-->
    <script src="statci/js/handlebars-v4.7.6.js"></script>
    <script>

    </script>
</head>

<body>
    <!-- 顶部快捷导航start -->
    <div class="shortcut " style="margin-top: 0px;">
        <div class="shortcut" style="margin-top: 0px;">
            <div class="w">
                <div class="fl">
                    <ul>
                        <li>XX外卖欢迎您！ </li>
                        <li>
                            <a href="./statci/login.html" id="a_username">请登录</a>
                            <a href="register.html" class="style-red" id="regiseter">免费注册</a>
                            <a href="../UserServlet/UserQuit" id="quit">退出登录</a>
                            <a href="javascript:;" id="userIdd"></a>
                        </li>
                    </ul>
                </div>
                <div class="fr">
                    <ul>
                        <li><a href="#">我的订单</a></li>
                        <li class="spacer"></li>
                        <li>
                            <a href="#">我的外卖</a>
                        </li>
                        <li class="spacer"></li>
                        <li><a href="#">XX外卖会员</a></li>
                        <li class="spacer"></li>
                        <li><a href="#">企业采购</a></li>
                        <li class="spacer"></li>
                        <li><a href="#">关注我们</a></li>
                        <li class="spacer"></li>
                        <li><a href="#">客户服务</a> </li>
                        <li class="spacer"></li>
                        <li><a href="#">网站导航</a> </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- 顶部快捷导航end  -->


    <div class="car-header">
        <div class="w">
            <div class="car-logo">
                <img src="./statci/img/logo1.png" alt=""> <b>购物车</b>
            </div>
        </div>
    </div>

    </div>
    <div class="c-container">
        <div class="w">
            <div class="cart-filter-bar">
                <em>全部商品</em>
            </div>
            <!-- 购物车主要核心区域 -->
            <div class="cart-warp">
                <!-- 头部全选模块 -->
                <div class="cart-thead">
                    <div class="t-checkbox">
                        <input type="checkbox" name="" id="" class="checkall"> 全选
                    </div>
                    <div class="t-goods">商品</div>

                    <div class="t-price">单价</div>
                    <div class="t-num">数量</div>
                    <div class="t-sum">小计</div>
                    <div class="t-action">操作</div>
                </div>
                <!-- 商品详细模块 -->
                <div class="cart-item-list" id="car-lis">


                </div>

                <!-- 结算模块 -->
                <div class="cart-floatbar">
                    <div class="select-all">
                        <input type="checkbox" name="" id="" class="checkall">全选
                    </div>
                    <div class="operation">
                        <a href="javascript:;" class="remove-batch"> 删除选中的商品</a>
                        <a href="javascript:;" class="clear-all">清理购物车</a>
                    </div>
                    <div class="toolbar-right">
                        <div class="amount-sum">已经选<em>0</em>件商品</div>
                        <div class="price-sum">总价： <em>￥0.00</em></div>
                        <div class="btn-area" onclick="toPay()">去结算</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- footer start -->
    <div class="footer">
        <div class="w">
            <!-- mod_service -->
            <div class="mod_service">
                <ul>
                    <li>
                        <i class="mod-service-icon mod_service_zheng"></i>
                        <div class="mod_service_tit">
                            <h5>正品保障</h5>
                            <p>正品保障，提供发票</p>
                        </div>
                    </li>
                    <li>
                        <i class="mod-service-icon mod_service_kuai"></i>
                        <div class="mod_service_tit">
                            <h5>正品保障</h5>
                            <p>正品保障，提供发票</p>
                        </div>
                    </li>
                    <li>
                        <i class="mod-service-icon mod_service_bao"></i>
                        <div class="mod_service_tit">
                            <h5>正品保障</h5>
                            <p>正品保障，提供发票</p>
                        </div>
                    </li>
                    <li>
                        <i class="mod-service-icon mod_service_bao"></i>
                        <div class="mod_service_tit">
                            <h5>正品保障</h5>
                            <p>正品保障，提供发票</p>
                        </div>
                    </li>
                    <li>
                        <i class="mod-service-icon mod_service_bao"></i>
                        <div class="mod_service_tit">
                            <h5>正品保障</h5>
                            <p>正品保障，提供发票</p>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- mod_help -->
            <div class="mod_help">
                <dl class="mod_help_item">
                    <dt>购物指南</dt>
                    <dd> <a href="#">购物流程 </a></dd>
                    <dd> <a href="#">会员介绍 </a></dd>
                    <dd> <a href="#">生活旅行/团购 </a></dd>
                    <dd> <a href="#">常见问题 </a></dd>
                    <dd> <a href="#">大家电 </a></dd>
                    <dd> <a href="#">联系客服 </a></dd>
                </dl>
                <dl class="mod_help_item">
                    <dt>购物指南</dt>
                    <dd> <a href="#">购物流程 </a></dd>
                    <dd> <a href="#">会员介绍 </a></dd>
                    <dd> <a href="#">生活旅行/团购 </a></dd>
                    <dd> <a href="#">常见问题 </a></dd>
                    <dd> <a href="#">大家电 </a></dd>
                    <dd> <a href="#">联系客服 </a></dd>
                </dl>
                <dl class="mod_help_item">
                    <dt>购物指南</dt>
                    <dd> <a href="#">购物流程 </a></dd>
                    <dd> <a href="#">会员介绍 </a></dd>
                    <dd> <a href="#">生活旅行/团购 </a></dd>
                    <dd> <a href="#">常见问题 </a></dd>
                    <dd> <a href="#">大家电 </a></dd>
                    <dd> <a href="#">联系客服 </a></dd>
                </dl>
                <dl class="mod_help_item">
                    <dt>购物指南</dt>
                    <dd> <a href="#">购物流程 </a></dd>
                    <dd> <a href="#">会员介绍 </a></dd>
                    <dd> <a href="#">生活旅行/团购 </a></dd>
                    <dd> <a href="#">常见问题 </a></dd>
                    <dd> <a href="#">大家电 </a></dd>
                    <dd> <a href="#">联系客服 </a></dd>
                </dl>
                <dl class="mod_help_item">
                    <dt>购物指南</dt>
                    <dd> <a href="#">购物流程 </a></dd>
                    <dd> <a href="#">会员介绍 </a></dd>
                    <dd> <a href="#">生活旅行/团购 </a></dd>
                    <dd> <a href="#">常见问题 </a></dd>
                    <dd> <a href="#">大家电 </a></dd>
                    <dd> <a href="#">联系客服 </a></dd>
                </dl>

            </div>


        </div>
    </div>
    <!-- footer end -->
    <script type="text/template" id="tbody-tr">
        {{#each this}}
        <div class="cart-item">
            <div class="p-checkbox">
                <input type="checkbox" name="" id="" class="j-checkbox">
            </div>

            <div class="p-goods">
                <div class="p-img">
                    <img src=".{{foodPic}}" alt="" style="width: 80px;height :80px"> </div>
                <div class="p-msg">
                    <span style="color:#999999;" class="p-biz">【{{bizId}}】</span>
                    {{foodName}}</div>
            </div>
            <div class="p-price">{{foodPrice}}</div>

            <span class="listID" style="display: none" >{{listId}}</span>
            <div class="p-num">
                <div class="quantity-form">
                    <a href="javascript:;" class="decrement">-</a>
                    <input type="text" class="itxt" value="{{foodNum}}">
                    <a href="javascript:;" class="increment">+</a>

                </div>
            </div>
            <div class="p-sum"></div>
            <div class="p-action"><a href="javascript:;" data-listId="" onclick="delF({{listId}})">删除</a></div>
        </div>
        {{/each}}
    </script>

    <script>
        function delF(d) {
            console.log(d)
            $.get("../UserServlet/delBuyCar", { "listId": d }, function () {
            })
        }
        function toPay() {
            var bId = $('.check-cart-item .p-biz:first').html();
            var flag;
            $('.check-cart-item .p-biz').each(function () {
                if ($(this).html() == bId) {
                    flag = true;
                } else {
                    flag = false;
                    return false;
                }

            })
            if (flag) {
                var food = new Array()
                // var food=[];
                $('.check-cart-item').each(function () {
                    console.log($(this).find(".listID").html())
                    food.push($(this).find(".listID").html());
                })
                console.log(food)
                $.ajaxSettings.traditional = true
                $.post("../UserServlet/toPay", { foods: food }, function (data) {
                    var obj = JSON.parse(data);
                    console.log(obj);
                    var s = window.localStorage;
                    s.removeItem("buylist");
                    s["buylist"] = data;
                    location.href = 'pay.html';
                })
            } else {
                alert("每次仅可提交一个商家的商品")
            }


        }
        $(function () {
            $.get("../UserServlet/finUserName", function (data) {
                if (data == null) {
                    $('#a_username').html("欢迎登录");
                    $("#quit").hide();
                    $("#regiseter").show();
                } else {
                    console.log(data);
                    $("#quit").show();
                    $("#regiseter").hide();
                    $('#a_username').html(data.userName);
                    b = data.userId
                    $('#userIdd').html(data.userId);
                    $('#userIdd').hide();
                    //获取购物车内商品信息
                    $.post("../UserServlet/byCarList", { "userId": b }, function (data) {
                        console.log(data)
                        var tpl = $('#tbody-tr').html();
                        var template = Handlebars.compile(tpl);
                        $("#car-lis").html(template(data));
                        fff();
                        f();
                    })
                }
            })
        })



    </script>
    <!-- 在引入自己的js文件 -->
    <script>
        function f() {
            var n = document.querySelectorAll(".itxt");
            var p = document.querySelectorAll(".p-price");
            var z = document.querySelectorAll(".p-sum");
            for (let i = 0; i < n.length; i++) {
                z[i].innerHTML = "￥" + (parseInt(n[i].value) * parseFloat(p[i].innerHTML)).toFixed(2);
                p[i].innerHTML = "￥" + p[i].innerHTML;
            }
        }

        /**
         * 同步更改购物车商品数量
         */
        function changeBuyCarNum(data, id) {
            $.post("../UserServlet/changeBuyCarNum", { "listId": id, "foodNum": data }, function (d) {
                console.log(d)
            })

        }
        function fff() {
            $(".checkall").change(function () {
                $(".j-checkbox, .checkall").prop("checked", $(this).prop("checked"));
                if ($(this).prop("checked")) {
                    // 让所有的商品添加 check-cart-item 类名
                    $(".cart-item").addClass("check-cart-item");
                } else {
                    // check-cart-item 移除
                    $(".cart-item").removeClass("check-cart-item");
                }
                getSum();
            });
            // 2. 如果小复选框被选中的个数等于3 就应该把全选按钮选上，否则全选按钮不选。
            $(".j-checkbox").change(function () {

                if ($(".j-checkbox:checked").length === $(".j-checkbox").length) {
                    $(".checkall").prop("checked", true);
                } else {
                    $(".checkall").prop("checked", false);
                }
                if ($(this).prop("checked")) {
                    // 让当前的商品添加 check-cart-item 类名
                    $(this).parents(".cart-item").addClass("check-cart-item");
                } else {
                    // check-cart-item 移除
                    $(this).parents(".cart-item").removeClass("check-cart-item");
                }
                getSum();
            });
            // 3. 增减商品数量模块 首先声明一个变量，当我们点击+号（increment），就让这个值++，然后赋值给文本框。
            $(".increment").click(function () {
                // 得到当前兄弟文本框的值
                var n = $(this).siblings(".itxt").val();
                // console.log(n);
                n++;
                $(this).siblings(".itxt").val(n);
                var dd = $(this).parents(".p-num").siblings(".listID").html();
                console.log(dd);
                changeBuyCarNum(n, dd);
                // 3. 计算小计模块 根据文本框的值 乘以 当前商品的价格  就是 商品的小计
                // 当前商品的价格 p
                var p = $(this).parents(".p-num").siblings(".p-price").html();
                // console.log(p);
                p = p.substr(1);

                var price = (p * n).toFixed(2);
                // 小计模块
                // toFixed(2) 可以让我们保留2位小数
                $(this).parents(".p-num").siblings(".p-sum").html("￥" + price);
                getSum();
            });
            $(".decrement").click(function () {
                // 得到当前兄弟文本框的值
                var n = $(this).siblings(".itxt").val();
                if (n == 1) {
                    return false;
                }
                // console.log(n);
                n--;
                $(this).siblings(".itxt").val(n);
                var dd = $(this).parents(".p-num").siblings(".listID").html();
                changeBuyCarNum(n, dd);
                // var p = $(this).parent().parent().siblings(".p-price").html();
                // parents(".p-num") 返回指定的祖先元素
                var p = $(this).parents(".p-num").siblings(".p-price").html();
                // console.log(p);
                p = p.substr(1);

                // 小计模块
                $(this).parents(".p-num").siblings(".p-sum").html("￥" + (p * n).toFixed(2));
                getSum();
            });
            //  4. 用户修改文本框的值 计算 小计模块
            $(".itxt").change(function () {
                // 先得到文本框的里面的值 乘以 当前商品的单价
                var n = $(this).val();
                function delF(d) {
                    var dd = d;
                }
                var dd = $(this).parents(".p-num").siblings(".listID").html();
                changeBuyCarNum(n, dd);
                // 当前商品的单价
                var p = $(this).parents(".p-num").siblings(".p-price").html();
                // console.log(p);
                p = p.substr(1);
                $(this).parents(".p-num").siblings(".p-sum").html("￥" + (p * n).toFixed(2));
                getSum();
            });
            // 5. 计算总计和总额模块
            getSum();

            function getSum() {
                var count = 0; // 计算总件数
                var money = 0; // 计算总价钱

                $(".check-cart-item").find(".itxt").each(function (i, ele) {
                    count += parseInt($(ele).val());
                });
                $(".amount-sum em").text(count);
                $(".check-cart-item").find(".p-sum").each(function (i, ele) {
                    money += parseFloat($(ele).text().substr(1));
                });
                $(".price-sum em").text("￥" + money.toFixed(2));
            }
            // 6. 删除商品模块
            // (1) 商品后面的删除按钮
            $(".p-action a").click(function () {
                // 删除的是当前的商品
                $(this).parents(".cart-item").remove();
                getSum();
            });
            // (2) 删除选中的商品
            $(".remove-batch").click(function () {
                // 删除的是小的复选框选中的商品
                $(".j-checkbox:checked").parents(".cart-item").remove();
                getSum();
            });
            // (3) 清空购物车 删除全部商品
            $(".clear-all").click(function () {
                $(".cart-item").remove();
                getSum();
            })
        }

    </script>


</body>

</html>